{{- if and .Values.notebook.enabled .Values.notebook.gitSync.enabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "fraud-detection.fullname" . }}-clone-notebooks
  namespace: {{ .Release.Namespace }}
  labels:
    {{- include "fraud-detection.labels" . | nindent 4 }}
    app.kubernetes.io/component: notebook
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "10"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-failed
spec:
  backoffLimit: 6
  template:
    metadata:
      labels:
        {{- include "fraud-detection.selectorLabels" . | nindent 8 }}
        app.kubernetes.io/component: notebook-setup
    spec:
      serviceAccountName: {{ include "fraud-detection.serviceAccountName" . }}
      restartPolicy: OnFailure
      initContainers:
      - name: wait-for-pvc
        image: busybox:1.35
        command:
        - sh
        - -c
        - |
          echo "Waiting for PVC to be bound..."
          RETRIES=30
          COUNT=0
          until [ -d /workspace ] && [ -w /workspace ]; do
            COUNT=$((COUNT+1))
            if [ $COUNT -ge $RETRIES ]; then
              echo "PVC not ready after $RETRIES attempts, giving up"
              exit 1
            fi
            echo "PVC not yet available, waiting... (attempt $COUNT/$RETRIES)"
            sleep 5
          done
          echo "PVC is ready and writable"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
      containers:
      - name: git-clone
        image: {{ .Values.notebook.gitSync.image }}
        command:
        - sh
        - -c
        - |
          set -e
          cd /workspace
          
          # Check if notebooks already exist
          if [ -d "demo/notebooks" ] && [ "$(ls -A demo/notebooks 2>/dev/null)" ]; then
            echo "Notebooks already exist in workspace, skipping clone"
            exit 0
          fi
          
          # Clone the repository with retry logic
          echo "Cloning repository: {{ .Values.notebook.gitSync.repo }}"
          RETRIES=5
          COUNT=0
          until git clone --depth 1 {{ if .Values.notebook.gitSync.branch }}--branch {{ .Values.notebook.gitSync.branch }}{{ end }} {{ .Values.notebook.gitSync.repo }} /tmp/repo; do
            COUNT=$((COUNT+1))
            if [ $COUNT -ge $RETRIES ]; then
              echo "Failed to clone repository after $RETRIES attempts"
              echo "This may be due to network issues. You can manually clone the notebooks later."
              exit 0  # Exit gracefully to not block installation
            fi
            echo "Clone failed, retrying in 10 seconds... (attempt $COUNT/$RETRIES)"
            sleep 10
          done
          
          # Copy notebooks to workspace
          echo "Copying notebooks to workspace..."
          mkdir -p demo/notebooks
          if [ -d "/tmp/repo/demo/notebooks" ]; then
            cp -r /tmp/repo/demo/notebooks/* demo/notebooks/ 2>/dev/null || echo "Warning: Some notebooks may not have been copied"
          else
            echo "Warning: No notebooks directory found in repository"
          fi
          
          # Copy scripts if they exist
          if [ -d "/tmp/repo/demo/scripts" ]; then
            mkdir -p demo/scripts
            cp -r /tmp/repo/demo/scripts/* demo/scripts/ 2>/dev/null || echo "Warning: Some scripts may not have been copied"
          fi
          
          # Copy pipelines if they exist
          if [ -d "/tmp/repo/demo/pipelines" ]; then
            mkdir -p demo/pipelines
            cp -r /tmp/repo/demo/pipelines/* demo/pipelines/ 2>/dev/null || echo "Warning: Some pipelines may not have been copied"
          fi
          
          # Clean up
          rm -rf /tmp/repo
          
          echo "Notebooks successfully copied to workspace"
          ls -la demo/notebooks/ 2>/dev/null || echo "Notebooks directory is empty or doesn't exist"
        volumeMounts:
        - name: workspace
          mountPath: /workspace
      volumes:
      - name: workspace
        persistentVolumeClaim:
          claimName: {{ include "fraud-detection.fullname" . }}-notebook-pvc
{{- end }}

