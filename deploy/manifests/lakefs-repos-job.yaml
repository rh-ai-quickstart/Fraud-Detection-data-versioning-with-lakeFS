apiVersion: batch/v1
kind: Job
metadata:
  name: create-lakefs-repo
spec:
  template:
    spec:
      containers:
        - name: create-repo
          image: curlimages/curl:latest
          command:
            - /bin/sh
            - -c
            - |
              # Wait for lakeFS to be ready
              echo "Waiting for lakeFS service to be ready..."
              while ! curl -s http://my-lakefs.lakefs.svc.cluster.local:80/_health; do
                echo -n "."
                sleep 5
              done
              echo "lakeFS is ready!"
              echo
              echo
              # Create repository using lakeFS API
              echo "Creating quickstart repository..."
              curl -u "something:simple" \
                   -X POST \
                   -H "Content-Type: application/json" \
                   -d '{"name": "quickstart", "storage_namespace": "s3://quickstart/", "default_branch": "main", "sample_data": true}' \
                   http://my-lakefs.lakefs.svc.cluster.local/api/v1/repositories || true
              echo "quickstart repository created!"
              echo
              echo
              echo "Creating my-storage repository..."
              curl -u "something:simple" \
                   -X POST \
                   -H "Content-Type: application/json" \
                   -d '{"name": "my-storage", "storage_namespace": "s3://my-storage/", "default_branch": "main"}' \
                   http://my-lakefs.lakefs.svc.cluster.local/api/v1/repositories || true
              echo "my-storage repository created!"
      restartPolicy: Never
      serviceAccountName: demo-setup